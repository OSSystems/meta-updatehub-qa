From 97564bd479f079d57ac30face3d662d136d9f380 Mon Sep 17 00:00:00 2001
From: Otavio Salvador <otavio@ossystems.com.br>
Date: Fri, 21 Jul 2017 16:46:17 -0300
Subject: [PATCH 5/5] vexpress-ca9x4: Enable use of UpdateHub
Organization: O.S. Systems Software LTDA.

Signed-off-by: Otavio Salvador <otavio@ossystems.com.br>
---
 configs/vexpress_ca9x4_defconfig |  2 ++
 include/configs/vexpress_ca9x4.h | 53 ++++++++++++++++++++++++++++++++++++++++
 2 files changed, 55 insertions(+)

diff --git a/configs/vexpress_ca9x4_defconfig b/configs/vexpress_ca9x4_defconfig
index 7b845c6c79..9547e36a96 100644
--- a/configs/vexpress_ca9x4_defconfig
+++ b/configs/vexpress_ca9x4_defconfig
@@ -17,6 +17,8 @@ CONFIG_CMD_MMC=y
 # CONFIG_CMD_SETEXPR is not set
 # CONFIG_CMD_NFS is not set
 # CONFIG_CMD_MISC is not set
+CONFIG_CMD_UBI=y
+CONFIG_CMD_UBIFS=y
 CONFIG_MTD_NOR_FLASH=y
 CONFIG_BAUDRATE=38400
 CONFIG_OF_LIBFDT=y
diff --git a/include/configs/vexpress_ca9x4.h b/include/configs/vexpress_ca9x4.h
index 993398ccc6..58b3d0ea48 100644
--- a/include/configs/vexpress_ca9x4.h
+++ b/include/configs/vexpress_ca9x4.h
@@ -14,4 +14,57 @@
 #define CONFIG_VEXPRESS_ORIGINAL_MEMORY_MAP
 #include "vexpress_common.h"
 
+#define CONFIG_RBTREE
+#define CONFIG_CMD_MTDPARTS
+#define CONFIG_MTD_DEVICE
+#define CONFIG_MTD_PARTITIONS
+#define CONFIG_MTD_CONCAT
+#define CONFIG_FLASH_CFI_MTD
+#define CONFIG_LZO
+
+#ifdef CONFIG_SYS_MALLOC_LEN
+#undef CONFIG_SYS_MALLOC_LEN
+#define CONFIG_SYS_MALLOC_LEN (8 * 1024 * 1024)
+#endif
+
+#define MTDIDS_DEFAULT		"nor2=40000000.flash"
+#define MTDPARTS_DEFAULT	"mtdparts=40000000.flash:"					\
+  "1m(u-boot)ro," \
+  "1m(u-boot-env)," \
+  "-(ubi)"
+
+#undef CONFIG_ENV_ADDR
+#undef CONFIG_ENV_OFFSET
+#define CONFIG_ENV_ADDR	(CONFIG_SYS_FLASH_BASE0 + CONFIG_ENV_OFFSET)
+#define CONFIG_ENV_OFFSET 0x100000
+
+#define CONFIG_ENV_ADDR_REDUND (CONFIG_SYS_FLASH_BASE0 + CONFIG_ENV_OFFSET_REDUND)
+#define CONFIG_ENV_OFFSET_REDUND (CONFIG_ENV_OFFSET + CONFIG_ENV_SIZE)
+
+/*
+ * UpdateHub configuration
+ */
+
+#define CONFIG_BOOTCOUNT_ENV
+
+#define UPDATEHUB_LOAD_OS_A     "ubifsload ${kernel_addr_r} /boot/zImage; ubifsload ${fdt_addr_r} /boot/vexpress-v2p-ca9.dtb"
+#define UPDATEHUB_FIND_ROOT_A   "ubi part ubi; ubifsmount ubi0:rootfsa; setenv ubiroot ubi0:rootfsa"
+
+#define UPDATEHUB_LOAD_OS_B     UPDATEHUB_LOAD_OS_A
+#define UPDATEHUB_FIND_ROOT_B   "ubi part ubi; ubifsmount ubi0:rootfsb; setenv ubiroot ubi0:rootfsb"
+
+#define UPDATEHUB_BOOTARGS      "${mtdparts} ubi.mtd=2 root=${ubiroot} rootfstype=ubifs ubi.fm_autoconvert=1 rootwait ro console=${console}"
+#define UPDATEHUB_BOOTCMD       "bootz ${kernel_addr_r} - ${fdt_addr_r}"
+
+#include <configs/updatehub-common.h>
+
+#undef CONFIG_EXTRA_ENV_SETTINGS
+#define CONFIG_EXTRA_ENV_SETTINGS			\
+	CONFIG_PLATFORM_ENV_SETTINGS \
+            BOOTENV \
+	"kernel_addr_r=0x60100000\0" \
+	"fdt_addr_r=0x60000000\0" \
+    "console=ttyAMA0,38400n8\0" \
+	UPDATEHUB_ENV
+
 #endif /* VEXPRESS_CA9X4_H */
-- 
2.13.3

